---
title: "R Notebook"
output: html_notebook
---
***
###Creating PPP

Import the traffic dataset and coverting the crs from WGS84 to SVY21, at the same time, fixing the x and y for ppp function later. Result is exported to a temp csv file located in /data.
```{r}
library(readr)
library(sf)
trafficReport <- read_csv("data/LTATrafficDataClean2.csv")
trafficReport_shp <- st_as_sf(trafficReport, coords = c("Longitude", "Latitude"), crs = "+proj=longlat +datum=WGS84 +no_defs")
traffic_Report_svy21 <- st_transform(trafficReport_shp, crs = 3414)
st_write(traffic_Report_svy21, "data/temp.csv", layer_options = "GEOMETRY=AS_XY") # writes X and Y as columns
```

***
Reading the temp csv and creating the ppp
```{r}
library(tidyverse)
library(spatstat)
temp <- read_csv("data/temp.csv")
accidents <- temp %>% filter(Type == "Accident")
roadworks <- temp %>% filter(Type == "Roadwork")
heavytraffic <- temp %>% filter(Type == "Heavy Traffic")
accidents_ppp <- ppp(accidents$X, accidents$Y, c(min(accidents$X), max(accidents$X)), c(min(accidents$Y), max(accidents$Y)))
roadworks_ppp <- ppp(roadworks$X, roadworks$Y, c(min(roadworks$X), max(roadworks$X)), c(min(roadworks$Y), max(roadworks$Y)))
heavytraffic_ppp <- ppp(heavytraffic$X, heavytraffic$Y, c(min(heavytraffic$X), max(heavytraffic$X)), c(min(heavytraffic$Y), max(heavytraffic$Y)))
plot(accidents_ppp)
plot(roadworks_ppp)
plot(heavytraffic_ppp)
```

##Preparing the linnet
```{r}
library(maptools)
roadNetwork <- readShapeSpatial("data/RoadNetwork/roads_expressway")
roadNetwork_psp <- as.psp(roadNetwork, window=NULL, marks=NULL, check=spatstat.options("checksegments"), fatal=TRUE)
roadNetwork_linnet <- as.linnet.psp(roadNetwork_psp, sparse=TRUE)
plot(roadNetwork_linnet)
```

##LPP
Generating the LPP

```{r}
accidents_lpp <- lpp(accidents_ppp, roadNetwork_linnet)
heavytraffic_lpp <- lpp(heavytraffic_ppp, roadNetwork_linnet)
```

***
###K Function
Plotting the K function
```{r}
plot(linearK(accidents_lpp, correction="none", ratio=FALSE))
```

***
###Kernel Density Estimation
Plotting the KDE
```{r}
plot(density.lpp(accidents_lpp, 1000))
plot(density.ppp(accidents_ppp, 1000))
plot(density.lpp(heavytraffic_lpp, 3000))
plot(density.ppp(heavytraffic_ppp, 1000))
```


***
###K Nearest Neighbour
Plotting the knn
```{r}
library(spatstat)
hist(nndist.lpp(accidents_lpp, k=10, method="C"))
plot(nnfun.lpp(accidents_lpp, k=10, method="C"))
plot(Gest(accidents_ppp), xlim=c(0,2000))
hist(nndist.lpp(heavytraffic_lpp, k=10, method="C"))
plot(nnfun.lpp(heavytraffic_lpp, k=10, method="C"))
plot(Gest(heavytraffic_ppp), xlim=c(0,2000))
```

***
###Extra stuffs
Trying to map kde onto osm, ignore for now

```{r}
temp <- density.lpp(accidents_lpp, 1000)
class(temp)
```


```{r}
library(leaflet.extras)
library(maptools)
temp <- readShapeSpatial("data/RoadNetwork/roads_expressway", proj4string=CRS("+proj=longlat +datum=WGS84 +no_defs"))
 m <- leaflet() %>% 
       addProviderTiles(providers$CartoDB.Positron) %>%
       addCSVHeatmap(temp, trafficReport)
       #addCircleMarkers(trafficReport, lng = trafficReport$Longitude, lat = trafficReport$Latitude, popup = trafficReport$Descriptions, radius = .5, opacity = .2, col = "Blue")

m
```

